<?phpnamespace Centersis\Zion\Pixel\Arquivo;use Centersis\Zion\Arquivo\ManipulaImagem;use Centersis\Zion\Exception\ValidationException;use Centersis\Zion\Exception\ErrorException;abstract class ArquivoUpload {       /**     *      * @var ManipulaImagem     */    protected $manipulaImagem;    protected $organogramaCod;    protected $con;    public function __construct($organogramaCod, $con) {        $this->organogramaCod = $organogramaCod;        $this->con = $con;        $this->manipulaImagem = new ManipulaImagem();    }    /**     * Realiza o upload de um ou mais arquivos para uma pasta padrão do sistema     * chamada Storage, cada arquivo é guardado dentro de uma pasta com o      * caminho que representa a data de Upload. Ex: um arquivo enviado no dia      * 13/01/2015 ficaria no seguinte diretorio:      * SIS_DIR_BASE . 'Storage/2015/01/13/nome_arquivo.sua_extensão     *      * @param \Pixel\Form\FormUpload $config     * @return void     */    public function sisUpload($config) {        if ($config->getDisabled() === true) {            return;        }        $uploadCodReferencia = $config->getCodigoReferencia();        $nomeImput = str_replace('[]', '', $config->getNome());        $totalDoForm = $this->contaArquivos($nomeImput);        $upsPermitido = ini_get("max_file_uploads");        $dimensoes = $config->getDimensoes();        //Maximo de uploads ultrapassado - Existem servidorem que não retornan esse parametro        if ($totalDoForm > $upsPermitido and!empty($upsPermitido)) {            throw new ErrorException("Seu servidor permite envio de no maximo " . $upsPermitido . " arquivos simultaneos, remova alguns arquivos e tente novamente.");        }        $ano = date('Y');        $mes = date('m');        $dia = date('d');        $this->manipulaImagem->criaDiretorioStorage($ano, $mes, $dia, $dimensoes);        $moduloCod = $this->getModuloCod($config->getModulo());        $uploadNomeCampo = $config->getNomeCampo() ? $config->getNomeCampo() : $nomeImput;        if ($uploadCodReferencia) {            $qbTotalDoBanco = $this->con->qb();            $qbTotalDoBanco->select('COUNT(upload_cod)')                    ->from('_upload', '')                    ->where($qbTotalDoBanco->expr()->eq('modulo_cod', $moduloCod))                    ->andWhere($qbTotalDoBanco->expr()->eq('upload_cod_referencia', $uploadCodReferencia))                    ->andWhere($qbTotalDoBanco->expr()->eq('upload_nome_campo', $qbTotalDoBanco->expr()->literal($uploadNomeCampo)));            $totalDoBanco = $this->con->execRLinha($qbTotalDoBanco);            $removidos = filter_input(INPUT_POST, 'sisUR' . $nomeImput, FILTER_DEFAULT, FILTER_REQUIRE_ARRAY);            $totalRemovidos = 0;            if (is_array($removidos)) {                $totalRemovidos = count($removidos);            }            $totalArquivos = $totalDoForm + ($totalDoBanco - $totalRemovidos);            if (is_array($removidos)) {                foreach ($removidos as $codigoARemover) {                    $this->removerArquivos($config, $uploadCodReferencia, $codigoARemover);                }            }        } else {            $totalArquivos = $totalDoForm;        }        $minimoArquivos = $config->getMinimoArquivos();        $maximoArquivos = $config->getMaximoArquivos();        if (!empty($minimoArquivos) and $totalArquivos < $minimoArquivos) {            throw new ValidationException("Você deve selecionar no minimo " . $minimoArquivos . " arquivo" . (($minimoArquivos > 1) ? "s." : "."));        }        if (!empty($maximoArquivos) and $totalArquivos > $maximoArquivos) {            throw new ValidationException("$totalArquivos Você deve selecionar no maximo " . $maximoArquivos . " arquivo" . (($maximoArquivos > 1) ? "s." : "."));        }        $tamanhoMaximo = $config->getTamanhoMaximoEmBytes();        $extensaoPermitida = $config->getExtensoesPermitidas();        $extensaoNaoPermitida = $config->getExtensoesNaoPermitidas();        $tratarComo = $config->getTratarComo();        if ($totalDoForm > 0) {            if (is_array($_FILES[$nomeImput]['name'])) {                $dadosFiles = $_FILES[$nomeImput]['name'];            } else {                $dadosFiles = ['fake' => true]; //Upload Simples            }            foreach (array_keys($dadosFiles) as $posicao) {                if ($posicao === 'fake') {                    $nomeOriginal = $_FILES[$nomeImput]['name'];                    $uploadMime = $_FILES[$nomeImput]['type'];                    $tamanhoEmBytes = $_FILES[$nomeImput]['size'];                    $origem = $_FILES[$nomeImput]['tmp_name'];                } else {                    $nomeOriginal = $_FILES[$nomeImput]['name'][$posicao];                    $uploadMime = $_FILES[$nomeImput]['type'][$posicao];                    $tamanhoEmBytes = $_FILES[$nomeImput]['size'][$posicao];                    $origem = $_FILES[$nomeImput]['tmp_name'][$posicao];                }                $extensao = strtolower($this->manipulaImagem->extenssaoArquivo($nomeOriginal));                //Crop sempre salva arquivo em formato png                if (is_array($config->getCrop())) {                    $pedacos = explode('.', $nomeOriginal);                    if (count($pedacos) > 1) {                        end($pedacos);                        $chave = key($pedacos);                        $pedacos[$chave] = 'png';                        reset($pedacos);                        $nomeOriginal = implode('.', $pedacos);                        $extensao = 'png';                    }                }                if (is_array($extensaoPermitida)) {                    $extensaoPermitida = array_map(strtolower, $extensaoPermitida);                    if (!in_array($extensao, $extensaoPermitida)) {                        throw new ValidationException("Extensão para o arquivo " . $nomeOriginal . " não é permitida. Use somente:" . implode(", ", $extensaoPermitida));                    }                }                if (is_array($extensaoNaoPermitida)) {                    $extensaoNaoPermitida = array_map(strtolower, $extensaoNaoPermitida);                    if (in_array($extensao, $extensaoNaoPermitida)) {                        throw new ValidationException("Extensão para o arquivo " . $nomeOriginal . " não é permitida.");                    }                }                if ($tamanhoMaximo and $tamanhoEmBytes > $tamanhoMaximo) {                    throw new ValidationException("O tamanho maximo de arquivo permitido é " . (($tamanhoMaximo / 1048576 * 100000) / 100000) . "MB");                }                //Grava na Tabela                           $qbInsert = $this->con->qb();                $qbInsert->insert('_upload')                        ->values([                            'organograma_cod' => '?',                            'modulo_cod' => '?',                            'upload_cod_referencia' => '?',                            'upload_nome_campo' => '?',                            'upload_nome_original' => '?',                            'upload_data_cadastro' => '?',                            'upload_mime' => '?'                        ])                        ->setParameter(0, $this->organogramaCod, \PDO::PARAM_INT)                        ->setParameter(1, $moduloCod, \PDO::PARAM_INT)                        ->setParameter(2, $uploadCodReferencia, \PDO::PARAM_INT)                        ->setParameter(3, $uploadNomeCampo, \PDO::PARAM_STR)                        ->setParameter(4, $nomeOriginal, \PDO::PARAM_STR)                        ->setParameter(5, ($ano . '-' . $mes . '-' . $dia), \PDO::PARAM_STR)                        ->setParameter(6, $uploadMime, \PDO::PARAM_STR);                $this->con->executar($qbInsert);                $uID = $this->con->ultimoId();                //Definindo Hash                $hashA = crypt($nomeOriginal, mt_rand()) . crypt($uID, mt_rand()) . $uID;                //Remove barras do hash se existir                $hashC = str_replace(['/', '\\', '.'], "9", $hashA) . '.' . $extensao;                //Atualiza Código Hash                $qbUpdate = $this->con->qb();                $qbUpdate->update('_upload')                        ->set('upload_nome_fisico', '?')                        ->setParameter(1, $hashC, \PDO::PARAM_STR)                        ->where($qbUpdate->expr()->eq('upload_cod', '?'))                        ->setParameter(2, $uID, \PDO::PARAM_INT);                $this->con->executar($qbUpdate);                //Setando Destino Arquivo                $destino = SIS_DIR_BASE . 'Storage/' . $this->organogramaCod . '/' . $ano . '/' . $mes . '/' . $dia . '/' . $hashC;                if ($tratarComo === "IMAGEM") {                    $destino = SIS_DIR_BASE . 'Storage/' . $this->organogramaCod . '/' . $ano . '/' . $mes . '/' . $dia . '/' . $hashC;                    if ($config->getCrop()) {                        $base64String = filter_input(INPUT_POST, 'sis_base64_crop_' . $config->getId());                        $this->uploadArquivoBase64($base64String, $destino);                    } else {                        $this->uploadArquivo($origem, $destino);                    }                    $origemOriginal = $destino;                    if (is_array($dimensoes)) {                        foreach ($dimensoes as $pasta => $configDaPasta) {                            $destino = SIS_DIR_BASE . 'Storage/' . $this->organogramaCod . '/' . $ano . '/' . $mes . '/' . $dia . '/' . $pasta . '/' . $hashC;                            $altura = array_key_exists('altura', $configDaPasta) ? $configDaPasta['altura'] : 0;                            $largura = array_key_exists('largura', $configDaPasta) ? $configDaPasta['largura'] : 0;                            $qualidade = array_key_exists('qualidade', $configDaPasta) ? $configDaPasta['qualidade'] : 100;                            $this->manipulaImagem->uploadImagem($nomeOriginal, $origemOriginal, $destino, $altura, $largura, $qualidade);                        }                    }                } else {                    $this->uploadArquivo($origem, $destino);                }            }        }    }    protected function getModuloCod($modulo = '') {        if (!$modulo) {            $modulo = MODULO;        }        $qbModulo = $this->con->qb();        $qbModulo->select('modulo_cod')                ->from('_modulo', '')                ->where($qbModulo->expr()->eq('modulo_nome', $qbModulo->expr()->literal($modulo)));        $moduloCod = $this->con->execRLinha($qbModulo);        if (!$moduloCod) {            throw new ValidationException('Módulo inválido! a definição atual é: "' . $modulo . '"');        }        return $moduloCod;    }    /**     * Este metodo remove apenas as ocorrenciar dos arquivos em banco de dados     * ignorando os arquivos físicos     *      * @param \Pixel\Form\FormUpload $config     * @param int $uploadCodReferencia     * @param int $uploadCod     * @return void     */    public function removerArquivos($config, $uploadCodReferencia, $uploadCod = 0) {        $qbSelect = $this->con->qb();        $moduloCod = $this->getModuloCod($config->getModulo());        $qbSelect->select('upload_cod', 'upload_nome_fisico', 'upload_data_cadastro')                ->from('_upload', '')                ->where($qbSelect->expr()->eq('organograma_cod', ':organograma_cod'))                ->andWhere($qbSelect->expr()->eq('upload_cod_referencia', ':upload_cod_referencia'))                ->andWhere($qbSelect->expr()->eq('modulo_cod', ':modulo_cod'))                ->setParameters([                    'organograma_cod' => $this->organogramaCod,                    'upload_cod_referencia' => $uploadCodReferencia,                    'modulo_cod' => $moduloCod        ]);        if ($uploadCod) {            $qbSelect->andWhere($qbSelect->expr()->eq('upload_cod', ':upload_cod'))                    ->setParameter('upload_cod', $uploadCod, \PDO::PARAM_INT);        }        $rS = $this->con->executar($qbSelect);        $nL = $this->con->nLinhas($rS);        if ($nL < 1) {            return;        }        while ($dados = $rS->fetch()) {            //Remove do banco            $qbDelete = $this->con->qb();            $qbDelete->delete('_upload', '')                    ->where($qbDelete->expr()->eq('organograma_cod', '?'))                    ->setParameter(1, $this->organogramaCod, \PDO::PARAM_INT)                    ->andWhere($qbDelete->expr()->eq('upload_cod_referencia', '?'))                    ->setParameter(2, $uploadCodReferencia, \PDO::PARAM_INT)                    ->andWhere($qbDelete->expr()->eq('upload_cod', '?'))                    ->setParameter(3, $dados['upload_cod'], \PDO::PARAM_INT);            $this->con->executar($qbDelete);            //Diretorios            $diretorioBase = SIS_DIR_BASE . 'Storage/' . $this->organogramaCod . '/' . str_replace('-', '/', $dados['upload_data_cadastro']) . '/';            $diretorioDestino = $diretorioBase . $dados['upload_nome_fisico'];            try {                $dimensoes = $config->getDimensoes();                $tratarComo = $config->getTratarComo();                if ($tratarComo === 'IMAGEM') {                    if (is_array($dimensoes)) {                        foreach (array_keys($dimensoes) as $pasta) {                            $diretorioPasta = $diretorioBase . $pasta . '/' . $dados['upload_nome_fisico'];                            $this->manipulaImagem->removeArquivo($diretorioPasta);                        }                    }                }                $this->manipulaImagem->removeArquivo($diretorioDestino);            } catch (\Exception $e) {                //não faz nada.            }        }    }    /**     * Mostra os arquivos existentes no banco de dados     * @param int $nomeImput     * @param int $uploadCodReferencia     * @return string     */    public function visualizarArquivos($nomeImput, $uploadCodReferencia, $modulo = '') {        $htmlArquivos = '';        if (is_numeric($uploadCodReferencia)) {            $moduloCod = $this->getModuloCod($modulo);            $qbSelect = $this->con->qb();            $qbSelect->select('upload_cod', 'upload_cod_referencia', 'upload_nome_original', 'upload_data_cadastro')                    ->from("_upload", '')                    ->andWhere($qbSelect->expr()->eq('upload_cod_referencia', ':upload_cod_referencia'))                    ->andWhere($qbSelect->expr()->eq('modulo_cod', ':modulo_cod'))                    ->andWhere($qbSelect->expr()->eq('upload_nome_campo', ':upload_nome_campo'))                    ->setParameters([                        'upload_cod_referencia' => $uploadCodReferencia,                        'modulo_cod' => $moduloCod,                        'upload_nome_campo' => $nomeImput            ]);            $rS = $this->con->executar($qbSelect);            $nR = $this->con->nLinhas($rS);            if ($nR > 0) {                $htmlArquivos .= '<div class="sisLabelMostraArquivos">Arquivos:</div>';                while ($dados = $rS->fetch()) {                    $htmlArquivos .= '<div class="labelMostraArquivos">';                    //sisUploadRemovido                    $htmlArquivos .= '<label><input name="sisUR' . $nomeImput . '[]" type="checkbox" value="' . $dados['upload_cod'] . '" /> Remover </label>';                    $htmlArquivos .= ' - <a target="_blank" href="' . SIS_URL_BASE_STORAGE . '?uid=' . $dados['upload_cod'] . '&modo=download" alt="' . $dados['upload_nome_original'] . '" border="0" >' . $dados['upload_nome_original'] . '</a>';                    $htmlArquivos .= '</div>';                }            }        }        return $htmlArquivos;    }    /**     * Cria um diretório com base no diretório base do sistema e nos parametros     * @param string $ano     * @param string $mes     * @param string $dia     */    public function criaDiretorioStorage($ano, $mes, $dia, $dimensoes) {        $this->manipulaImagem->criaDiretorio(SIS_DIR_BASE . 'Storage/' . $this->organogramaCod, 0777);        $this->manipulaImagem->criaDiretorio(SIS_DIR_BASE . 'Storage/' . $this->organogramaCod . '/' . $ano, 0777);        $this->manipulaImagem->criaDiretorio(SIS_DIR_BASE . 'Storage/' . $this->organogramaCod . '/' . $ano . '/' . $mes, 0777);        $this->manipulaImagem->criaDiretorio(SIS_DIR_BASE . 'Storage/' . $this->organogramaCod . '/' . $ano . '/' . $mes . '/' . $dia, 0777);        if (is_array($dimensoes)) {            foreach (array_keys($dimensoes) as $nomePasta) {                $this->manipulaImagem->criaDiretorio(SIS_DIR_BASE . 'Storage/' . $this->organogramaCod . '/' . $ano . '/' . $mes . '/' . $dia . '/' . $nomePasta, 0777);            }        }    }    /**     * Conta o número de arquivos contidos na variavel superglobal $_FILES     * @param string $nomeImput     * @return int     */    protected function contaArquivos($nomeImput) {        $total = 0;        if (isset($_FILES[$nomeImput]['size'])) {            if (is_array($_FILES[$nomeImput]['size'])) {                foreach ($_FILES[$nomeImput]['size'] as $size) {                    if ($size > 0) {                        $total++;                    }                }            } else if ($_FILES[$nomeImput]['size'] > 0) {                $total = 1;            }        }        return $total;    }}